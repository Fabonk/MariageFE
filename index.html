<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="https://wedding-guest-tracker.app/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire d'Invités de Mariage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Le CSS reste inchangé */
    </style>
</head>
<body>
    <!-- Le HTML reste inchangé -->

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDuFpPsBRE96la2TB8lVDGhpmTKm9JdHCU",
            authDomain: "mariagefabricesther.firebaseapp.com",
            databaseURL: "https://mariagefabricesther-default-rtdb.firebaseio.com",
            projectId: "mariagefabricesther",
            storageBucket: "mariagefabricesther.appspot.com",
            messagingSenderId: "219465158505",
            appId: "1:219465158505:web:5746c84cb4a14e27c7f7f8"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener('DOMContentLoaded', (event) => {
            const guestForm = document.getElementById('guestForm');
            const guestList = document.getElementById('guestList');
            const scanLog = document.getElementById('scanLog');
            const importButton = document.getElementById('importButton');
            const deleteAllGuestsButton = document.getElementById('deleteAllGuests');
            const scanResult = document.getElementById('scanResult');
            const startScanButton = document.getElementById('startScanButton');
            const readerDiv = document.getElementById('reader');
            const couplePhoto = document.getElementById('couplePhoto');
            const scannerModal = document.getElementById('scannerModal');
            const closeScannerModal = document.getElementById('closeScannerModal');
            let html5QrCode;

            // Référence à la base de données Firebase
            const guestsRef = ref(db, 'guests');
            const scansRef = ref(db, 'scans');

            // Écouter les changements dans la liste des invités
            onValue(guestsRef, (snapshot) => {
                const guests = snapshot.val() || {};
                updateGuestList(guests);
            });

            // Écouter les changements dans le journal des scans
            onValue(scansRef, (snapshot) => {
                const scans = snapshot.val() || {};
                updateScanLog(scans);
            });

            function updateGuestList(guests) {
                guestList.innerHTML = '';
                Object.entries(guests).forEach(([id, guest]) => {
                    const li = document.createElement('li');
                    
                    const guestInfo = document.createElement('div');
                    guestInfo.className = 'guest-info';
                    
                    const guestName = document.createElement('span');
                    guestName.className = 'guest-name';
                    guestName.textContent = guest.name;
                    
                    const guestTable = document.createElement('span');
                    guestTable.textContent = ` - Table: ${guest.table}`;
                    
                    guestInfo.appendChild(guestName);
                    guestInfo.appendChild(guestTable);
                    
                    const qrCodeDiv = document.createElement('div');
                    qrCodeDiv.className = 'qr-code';
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'guest-actions';
                    
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.className = 'edit-btn';
                    editButton.title = 'Modifier';
                    editButton.onclick = () => editGuest(id, guest);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteButton.className = 'delete-btn';
                    deleteButton.title = 'Supprimer';
                    deleteButton.onclick = () => deleteGuest(id);
                    
                    actionsDiv.appendChild(editButton);
                    actionsDiv.appendChild(deleteButton);
                    
                    li.appendChild(guestInfo);
                    li.appendChild(qrCodeDiv);
                    li.appendChild(actionsDiv);
                    guestList.appendChild(li);
                    
                    new QRCode(qrCodeDiv, {
                        text: id,
                        width: 64,
                        height: 64
                    });
                });
            }

            function updateScanLog(scans) {
                scanLog.innerHTML = '';
                Object.entries(scans).forEach(([id, scan]) => {
                    const li = document.createElement('li');
                    const scanName = document.createElement('span');
                    scanName.className = 'guest-name';
                    scanName.textContent = scan.name;
                    li.appendChild(scanName);
                    li.appendChild(document.createTextNode(` (Table: ${scan.table}) - ${new Date(scan.time).toLocaleString()}`));
                    scanLog.appendChild(li);
                });
            }

            function editGuest(id, guest) {
                const newName = prompt("Entrez le nouveau nom de l'invité:", guest.name);
                const newTable = prompt("Entrez le nouveau nom de la table:", guest.table);
                if (newName && newTable) {
                    set(ref(db, `guests/${id}`), { ...guest, name: newName, table: newTable });
                }
            }

            function deleteGuest(id) {
                if (confirm("Êtes-vous sûr de vouloir supprimer cet invité ?")) {
                    remove(ref(db, `guests/${id}`));
                }
            }

            guestForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const guestName = document.getElementById('guestName').value;
                const tableName = document.getElementById('tableName').value;
                const newGuestRef = push(guestsRef);
                set(newGuestRef, { name: guestName, table: tableName });

                document.getElementById('guestName').value = '';
                document.getElementById('tableName').value = '';
            });

            importButton.addEventListener('click', () => {
                const file = document.getElementById('excelFile').files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        jsonData.forEach(row => {
                            const newGuestRef = push(guestsRef);
                            set(newGuestRef, { name: row.Nom, table: row.Table });
                        });

                        alert('Invités importés avec succès !');
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert('Veuillez sélectionner un fichier Excel.');
                }
            });

            deleteAllGuestsButton.addEventListener('click', () => {
                if (confirm("Êtes-vous sûr de vouloir supprimer tous les invités ? Cette action est irréversible.")) {
                    remove(guestsRef);
                }
            });

            function qrCodeSuccessCallback(decodedText, decodedResult) {
                const guestRef = ref(db, `guests/${decodedText}`);
                onValue(guestRef, (snapshot) => {
                    const guest = snapshot.val();
                    if (guest) {
                        const scan = { name: guest.name, table: guest.table, time: new Date().toISOString() };
                        push(scansRef, scan);
                        scanResult.textContent = `Invité scanné: ${guest.name} - Table: ${guest.table}`;
                        scanResult.className = 'success';
                    } else {
                        scanResult.textContent = "Code QR non reconnu";
                        scanResult.className = 'error';
                    }
                    setTimeout(() => {
                        scanResult.textContent = '';
                        scanResult.className = '';
                    }, 3000);

                    // Fermer automatiquement le scanner après la détection
                    closeScannerModal.click();
                }, {
                    onlyOnce: true
                });
            }

            startScanButton.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanButton.textContent = 'Démarrer le scan du code QR';
                        scannerModal.style.display = 'none';
                    }).catch((err) => {
                        console.error('Erreur lors de l\'arrêt du scan:', err);
                    });
                } else {
                    html5QrCode = new Html5Qrcode("reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                    scannerModal.style.display = 'block';
                    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                        .then(() => {
                            startScanButton.textContent = 'Arrêter le scan';
                        })
                        .catch((err) => {
                            console.error('Erreur lors du démarrage du scan:', err);
                            alert('Erreur lors du démarrage de la caméra. Veuillez vérifier les permissions.');
                        });
                }
            });

            closeScannerModal.onclick = function() {
                scannerModal.style.display = "none";
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanButton.textContent = 'Démarrer le scan du code QR';
                    }).catch((err) => {
                        console.error('Erreur lors de l\'arrêt du scan:', err);
                    });
                }
            }

            window.onclick = function(event) {
                if (event.target == scannerModal) {
                    closeScannerModal.click();
                }
            }

            // Charger la photo des mariés si elle existe dans le localStorage
            const savedPhoto = localStorage.getItem('couplePhoto');
            if (savedPhoto) {
                couplePhoto.src = savedPhoto;
            }

            showPage('home');
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
        }
    </script>
</body>
</html>
