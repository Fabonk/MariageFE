<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionnaire d'Invités de Mariage</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="Icone.jpg" type="image/x-icon">
   <style>
  @font-face {
    font-family: 'Century Gothic';
    src: url('https://fonts.cdnfonts.com/css/century-gothic') format('woff2');
  }

  :root {
    --hooker-green: #01613C;
    --gold: #FFD700;
    --light-gold: #FFF2B2;
  }
  body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--light-gold);
    color: var(--hooker-green);
    line-height: 1.6;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }
  h1, h2 {
    color: var(--hooker-green);
    text-align: center;
  }
  .section {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--hooker-green);
    border-radius: 4px;
    font-family: 'Roboto', sans-serif;
    box-sizing: border-box;
    height: 40px;
  }
  button {
    background-color: var(--hooker-green);
    color: var(--gold);
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #014d30;
  }
  #qrcode, .qr-code {
    text-align: center;
    margin-top: 20px;
  }
  #guestList, #scanLog {
    list-style-type: none;
    padding: 0;
  }
  #guestList li, #scanLog li {
    background-color: var(--light-gold);
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #reader {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
  }
  .guest-info {
    flex-grow: 1;
  }
  .guest-name {
    font-family: 'Century Gothic', sans-serif;
    font-weight: bold;
    font-size: 1.2em;
    color: var(--hooker-green);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .qr-code {
    margin-left: 10px;
  }
  nav {
    background-color: var(--hooker-green);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  nav ul {
    list-style-type: none;
    padding: 0;
    display: flex;
    justify-content: space-around;
  }
  nav ul li a {
    color: var(--gold);
    text-decoration: none;
    font-weight: bold;
  }
  .page {
    display: none;
  }
  .active {
    display: block;
  }
  .guest-actions {
    display: flex;
    gap: 5px;
  }
  .guest-actions button {
    padding: 5px;
    font-size: 0.8em;
    width: auto;
  }
  .delete-all {
    background-color: #9e1a1a;
  }
  .delete-all:hover {
    background-color: #7a1414;
  }
  .edit-btn, .delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
  }
  .edit-btn {
    color: var(--hooker-green);
  }
  .delete-btn {
    color: #9e1a1a;
  }
  #scanResult {
    margin-top: 20px;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    font-weight: bold;
  }
  .success {
    background-color: #4CAF50;
    color: white;
  }
  .error {
    background-color: #f44336;
    color: white;
  }
  #startScanButton {
    background-color: var(--gold);
    color: var(--hooker-green);
    font-weight: bold;
    margin-bottom: 20px;
  }
  #startScanButton:hover {
    background-color: #e6c300;
  }
  #couplePhoto {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  #scannerModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
  }
  #scannerContent {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
  }
  #closeScannerModal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  #closeScannerModal:hover,
  #closeScannerModal:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
  }
  #reader video {
    width: 100%;
    height: auto;
  }
  #loginPage {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

#loginForm {
  display: flex;
  flex-direction: column;
  width: 300px;
}

#loginForm input, #loginForm button {
  margin-bottom: 10px;
}

.hidden {
  display: none !important;
}

.miniature {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 50%;
  margin-bottom: 20px;
}
#loginPage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #loginForm {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
  }
</style>
</head>
<body>
  <h1>Gestionnaire d'Invités de Mariage</h1>
  
<nav>
    <ul>
      <li><a href="#" onclick="showPage('home')">Accueil</a></li>
      <li><a href="#" onclick="showPage('guests')">Invités</a></li>
      <li><a href="#" onclick="showPage('scanner')">Scanner</a></li>
      <li><a href="#" onclick="showPage('log')">Journal</a></li>
      <li><a href="#" id="loginNavLink">Connexion</a></li>
      <li><a href="#" id="logoutNavLink" style="display: none;">Déconnexion</a></li>
  </ul>
</nav>

  <div id="homePage" class="page active">
    <div class="section">
      <h2>Bienvenue sur votre Gestionnaire d'Invités de Mariage</h2>
      <img id="couplePhoto" src="Icone.jpg" alt="Photo des mariés">
    </div>
  </div>

  <div id="guestsPage" class="page">
    <div class="section">
      <h2>Enregistrer un Invité</h2>
      <p id="guestCount">Nombre total d'invités : 0</p>
      <form id="guestForm" method="GET" action="/register-guest">
        <input type="text" id="guestName" name="guestName" placeholder="Nom de l'invité" required>
        <input type="text" id="tableName" name="tableName" placeholder="Nom de la table" required>
        <button type="submit">Enregistrer et Générer QR Code</button>
      </form>
    </div>

    <div class="section">
      <h2>Importer la Liste des Invités</h2>
      <input type="file" id="excelFile" accept=".xlsx, .xls" />
      <button id="importButton">Importer</button>
    </div>

    <div class="section">
      <h2>Liste des Invités</h2>
      <button id="deleteAllGuests" class="delete-all">Supprimer tous les invités</button>
      <ul id="guestList"></ul>
    </div>
  </div>

  <div id="scannerPage" class="page">
    <div class="section">
      <h2>Scanner un Code QR</h2>
      <button id="startScanButton">Démarrer le scan du code QR</button>
      <div id="scanResult"></div>
    </div>
  </div>

 <div id="logPage" class="page">
  <div class="section">
    <h2>Journal des Invités Scannés</h2>
    <p id="scanCount">Nombre d'invités scannés : 0</p>
    <button id="deleteAllScans" class="delete-all">Supprimer tous les scans</button>
    <ul id="scanLog"></ul>
  </div>
</div>

  <div id="scannerModal">
    <div id="scannerContent">
      <span id="closeScannerModal">&times;</span>
      <div id="reader"></div>
    </div>
  </div>

  <div id="loginPage" class="page">
    <div class="section">
      <img id="loginPhoto" src="Icone.jpg" alt="Photo des mariés" class="miniature">
      <h2>Connexion</h2>
      <form id="loginForm">
        <input type="text" id="username" placeholder="Nom d'utilisateur" required>
        <input type="password" id="password" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
      </form>
    </div>
  </div>
    <script type="module">
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDuFpPsBRE96la2TB8lVDGhpmTKm9JdHCU",
    authDomain: "mariagefabricesther.firebaseapp.com",
    databaseURL: "https://mariagefabricesther-default-rtdb.firebaseio.com",
    projectId: "mariagefabricesther",
    storageBucket: "mariagefabricesther.appspot.com",
    messagingSenderId: "219465158505",
    appId: "1:219465158505:web:5746c84cb4a14e27c7f7f8"
};

// Initialiser Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const users = {
    "admin@example.com": { role: "admin", password: "adminpass" },
    "user@example.com": { role: "user", password: "userpass" }
};

let currentUser = null;

// Fonction de connexion
function login(email, password) {
    if (users[email] && users[email].password === password) {
        currentUser = { email, role: users[email].role };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showAppropriatePages();
        return true;
    }
    return false;
}

// Fonction de déconnexion
function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    showLoginPage();
}

function checkLoginState() {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showAppropriatePages();
    } else {
        showLoginPage();
    }
}
// Afficher les pages appropriées selon le rôle de l'utilisateur
function showAppropriatePages() {
    document.getElementById('loginPage').style.display = 'none';
    document.querySelectorAll('.page').forEach(page => page.classList.remove('hidden'));
    document.getElementById('loginNavLink').style.display = 'none';
    document.getElementById('logoutNavLink').style.display = '';
    
    if (currentUser.role === 'user') {
        document.getElementById('scannerPage').classList.remove('hidden');
        document.getElementById('logPage').classList.remove('hidden');
    }
    
    updateUIForRole();
}

// Mettre à jour l'interface utilisateur en fonction du rôle
function updateUIForRole() {
    const isAdmin = currentUser.role === 'admin';
    
    // Masquer/afficher les éléments en fonction du rôle
    document.querySelectorAll('.edit-btn, .delete-btn, #deleteAllGuests, #deleteAllScans, #guestForm, #importButton').forEach(el => {
        el.style.display = isAdmin ? '' : 'none';
    });
    document.querySelectorAll('#guestForm input').forEach(input => {
        input.disabled = !isAdmin;
    });

    // Mettre à jour le texte du bouton de scan en fonction du rôle
    const scanButton = document.getElementById('startScanButton');
    if (scanButton) {
        scanButton.textContent = isAdmin ? 'Démarrer le scan du code QR' : 'Scanner un invité';
    }
}

// Afficher la page de connexion
function showLoginPage() {
    document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginNavLink').style.display = 'none';
    document.getElementById('logoutNavLink').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', (event) => {
    const guestForm = document.getElementById('guestForm');
    const guestList = document.getElementById('guestList');
    const scanLog = document.getElementById('scanLog');
    const importButton = document.getElementById('importButton');
    const deleteAllGuestsButton = document.getElementById('deleteAllGuests');
    const scanResult = document.getElementById('scanResult');
    const startScanButton = document.getElementById('startScanButton');
    const readerDiv = document.getElementById('reader');
    const couplePhoto = document.getElementById('couplePhoto');
    const scannerModal = document.getElementById('scannerModal');
    const closeScannerModal = document.getElementById('closeScannerModal');
    const guestCountElement = document.getElementById('guestCount');
    const scanCountElement = document.getElementById('scanCount');
    const deleteAllScansButton = document.getElementById('deleteAllScans');
    const loginPhoto = document.getElementById('loginPhoto');
    const loginForm = document.getElementById('loginForm');
    const loginNavLink = document.getElementById('loginNavLink');
    const logoutNavLink = document.getElementById('logoutNavLink');
    
    let html5QrCode;

    // Référence à la base de données Firebase
    const guestsRef = ref(db, 'guests');
    const scansRef = ref(db, 'scans');

    // Écouter les changements dans la liste des invités
    onValue(guestsRef, (snapshot) => {
        const guests = snapshot.val() || {};
        updateGuestList(guests);
    });

    // Écouter les changements dans le journal des scans
    onValue(scansRef, (snapshot) => {
        const scans = snapshot.val() || {};
        updateScanLog(scans);
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (login(email, password)) {
            showAppropriatePages();
        } else {
            alert('Identifiants incorrects');
        }
    });

    loginNavLink.addEventListener('click', (e) => {
        e.preventDefault();
        showLoginPage();
    });

    logoutNavLink.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
    });

    // Appeler checkLoginState au lieu de la vérification directe
    checkLoginState();


    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showAppropriatePages();
    } else {
        showLoginPage();
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                loginPhoto.src = couplePhoto.src;
            }
        });
    });

    observer.observe(couplePhoto, { attributes: true });

    deleteAllScansButton.addEventListener('click', deleteAllScans);

    function updateGuestList(guests) {
        guestList.innerHTML = '';
        const guestCount = Object.keys(guests).length;
        guestCountElement.textContent = `Nombre total d'invités : ${guestCount}`;
        Object.entries(guests).forEach(([id, guest]) => {
            const li = document.createElement('li');
            
            const guestInfo = document.createElement('div');
            guestInfo.className = 'guest-info';
            
            const guestName = document.createElement('span');
            guestName.className = 'guest-name';
            guestName.textContent = guest.name;
            
            const guestTable = document.createElement('span');
            guestTable.textContent = ` - Table: ${guest.table}`;
            
            guestInfo.appendChild(guestName);
            guestInfo.appendChild(guestTable);
            
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.className = 'qr-code';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'guest-actions';
            
            const editButton = document.createElement('button');
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.className = 'edit-btn';
            editButton.title = 'Modifier';
            editButton.onclick = () => editGuest(id, guest);
            
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.className = 'delete-btn';
            deleteButton.title = 'Supprimer';
            deleteButton.onclick = () => deleteGuest(id);
            
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            
            li.appendChild(guestInfo);
            li.appendChild(qrCodeDiv);
            li.appendChild(actionsDiv);
            guestList.appendChild(li);
            
            new QRCode(qrCodeDiv, {
                text: id,
                width: 64,
                height: 64
            });
        });
    }

    function deleteScan(id) {
        if (currentUser.role !== 'admin') {
            alert("Vous n'avez pas l'autorisation de supprimer les scans.");
            return;
        }
        if (confirm("Êtes-vous sûr de vouloir supprimer ce scan ?")) {
            remove(ref(db, `scans/${id}`));
        }
    }

    function deleteAllScans() {
        if (currentUser.role !== 'admin') {
            alert("Vous n'avez pas l'autorisation de supprimer tous les scans.");
            return;
        }
        if (confirm("Êtes-vous sûr de vouloir supprimer tous les scans ? Cette action est irréversible.")) {
            remove(ref(db, 'scans'));
        }
    }

    function updateScanLog(scans) {
        scanLog.innerHTML = '';
        const scanCount = Object.keys(scans).length;
        scanCountElement.textContent = `Nombre d'invités scannés : ${scanCount}`;
        Object.entries(scans).forEach(([id, scan]) => {
            const li = document.createElement('li');
            
            const scanInfo = document.createElement('div');
            scanInfo.className = 'scan-info';
            
            const scanName = document.createElement('span');
            scanName.className = 'guest-name';
            scanName.textContent = scan.name;
            
            const scanDetails = document.createElement('span');
            scanDetails.textContent = ` (Table: ${scan.table}) - ${new Date(scan.time).toLocaleString()}`;
            
            scanInfo.appendChild(scanName);
            scanInfo.appendChild(scanDetails);
            
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.className = 'delete-btn';
            deleteButton.title = 'Supprimer';
            deleteButton.onclick = () => deleteScan(id);
            
            li.appendChild(scanInfo);
            li.appendChild(deleteButton);
            scanLog.appendChild(li);
        });
    }

    function editGuest(id, guest) {
        if (currentUser.role !== 'admin') {
            alert("Vous n'avez pas l'autorisation de modifier les invités.");
            return;
        }
        const newName = prompt("Entrez le nouveau nom de l'invité:", guest.name);
        const newTable = prompt("Entrez le nouveau nom de la table:", guest.table);
        if (newName && newTable) {
            set(ref(db, `guests/${id}`), { ...guest, name: newName, table: newTable });
        }
    }

    function deleteGuest(id) {
        if (currentUser.role !== 'admin') {
            alert("Vous n'avez pas l'autorisation de supprimer les invités.");
            return;
        }
        if (confirm("Êtes-vous sûr de vouloir supprimer cet invité ?")) {
            remove(ref(db, `guests/${id}`));
        }
    }

    guestForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const guestName = document.getElementById('guestName').value;
        const tableName = document.getElementById('tableName').value;
        const newGuestRef = push(guestsRef);
        set(newGuestRef, { name: guestName, table: tableName });

        document.getElementById('guestName').value = '';
        document.getElementById('tableName').value = '';
    });

    importButton.addEventListener('click', () => {
        const file = document.getElementById('excelFile').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                jsonData.forEach(row => {
                    const newGuestRef = push(guestsRef);
                    set(newGuestRef, { name: row.Nom, table: row.Table });
                });

                alert('Invités importés avec succès !');
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Veuillez sélectionner un fichier Excel.');
        }
    });

    deleteAllGuestsButton.addEventListener('click', () => {
        if (confirm("Êtes-vous sûr de vouloir supprimer tous les invités ? Cette action est irréversible.")) {
            remove(guestsRef);
        }
    });

    function qrCodeSuccessCallback(decodedText, decodedResult) {
    const guestRef = ref(db, `guests/${decodedText}`);
    const scanRef = ref(db, `scans/${decodedText}`);

    onValue(guestRef, (snapshot) => {
        const guest = snapshot.val();
        if (guest) {
            // Vérifier si l'invité a déjà été scanné
            onValue(scanRef, (scanSnapshot) => {
                if (scanSnapshot.exists()) {
                    scanResult.textContent = `${guest.name} a déjà été scanné.`;
                    scanResult.className = 'error';
                } else {
                    const scan = { name: guest.name, table: guest.table, time: new Date().toISOString() };
                    set(scanRef, scan);
                    scanResult.textContent = `Invité scanné: ${guest.name} - Table: ${guest.table}`;
                    scanResult.className = 'success';
                }
                setTimeout(() => {
                    scanResult.textContent = '';
                    scanResult.className = '';
                }, 3000);

                // Fermer automatiquement le scanner après la détection
                closeScannerModal.click();
            }, {
                onlyOnce: true
            });
        }
    });
}

            startScanButton.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanButton.textContent = 'Démarrer le scan du code QR';
                        scannerModal.style.display = 'none';
                    }).catch((err) => {
                        console.error('Erreur lors de l\'arrêt du scan:', err);
                    });
                } else {
                    html5QrCode = new Html5Qrcode("reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                    scannerModal.style.display = 'block';
                    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                        .then(() => {
                            startScanButton.textContent = 'Arrêter le scan';
                        })
                        .catch((err) => {
                            console.error('Erreur lors du démarrage du scan:', err);
                            alert('Erreur lors du démarrage de la caméra. Veuillez vérifier les permissions.');
                        });
                }
            });

            closeScannerModal.onclick = function() {
                scannerModal.style.display = "none";
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanButton.textContent = 'Démarrer le scan du code QR';
                    }).catch((err) => {
                        console.error('Erreur lors de l\'arrêt du scan:', err);
                    });
                }
            }

            window.onclick = function(event) {
                if (event.target == scannerModal) {
                    closeScannerModal.click();
                }
            }

            // Charger la photo des mariés si elle existe dans le localStorage
            const savedPhoto = localStorage.getItem('couplePhoto');
            if (savedPhoto) {
                couplePhoto.src = savedPhoto;
            }

        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
        }
        showPage('home');
        window.showPage = function(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
        }
    </script>
</body>
</html>
